{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>分享打分系统</title>
    <link rel="stylesheet" href="{% static 'css/vote.css' %}">
    <script src="{% static 'js/jquery-3.2.1.js' %}"></script>

</head>
<body>
    <div class="box" style="height: 300px;text-align: center;margin: 10px auto;">
        <h1>分享-打分系统</h1>
        <ul>
            <li>
                <img src="/static/img/{{ cs.cImgName }}" title ="{{ cs.cDeclaration }}">
                演讲大神：{{ cs.cName }} <br> &nbsp;
                当前总分数：{% widthratio cs.cVotes 1 grads %}<br>

                班级总人数：60 <br>
                打分人数：{{ cs.cVotes }} <br>

                平均分：{{ grads }}<br>
                <button class="vote"  value="{{ cs.id }}"  name="{{ cs.cName }}" title ="{{ cs.cDeclaration }}">打分</button>
                <button class="chat" value="{{ cs.id }}"  name="{{ cs.cName }}" title ="{{ cs.cDeclaration }}">留言</button>

            </li>
        </ul>
    </div>

    <h2 style="height: 40px; width: 500px;">留言区</h2>
    <div id="chat" style="height: 250px; width: 700px;overflow: auto;border: 2px solid black;border-radius: 5px">

        <table class="table table-striped table-bordered table-hover table-condensed">
            <thead>
                <tr class="danger">
                    <th>留言时间</th>
                    <th>留言者</th>
                    <th>标题</th>
                    <th>内容</th>
                </tr>
            </thead>
            <tbody >
                {% if messages %}
                    {% for message in messages %}
                        <tr class="{% cycle 'active' 'success' 'warning' 'info' %}">
                            <td >{{ message.crTime|date:'Y-m-d H:i:s' }}</td>
                            <td style=" padding: 0 20px;">{{ message.crName }}</td>
                            <td style=" padding: 0 20px;">对{{  message.crTopic }}的评价</td>
                            <td style=" padding: 0 20px;">{{ message.crInfo }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4">无数据</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>

    </div>




    <script>
        jQuery(function ($) {
            $("button").click(function () {

                var val = $(this).attr("class");
                var name = $(this).attr("name");

                if(val == 'vote'){

                    var judge1 = prompt("请给"+name+"打分(0-100分)");
                    var whoId = $('.vote').attr("value");
                    grades = parseInt(judge1);
                    if( !checkNumber(judge1) || grades < 0 || grades > 100){
                        alert("分数范围为0-100");
                    }
                    else {
                        $.ajax({
                            url: '/vote/share/grade/'+whoId+ '/'+grades,
                            success: function (res) {
                                if (res == 1) {
                                    alert("打分成功!");
                                } else {
                                    alert("您今天已经对" + name + " 打过分了!");
                                }
                                window.location.reload();
                            }
                        });
                    }

                }else if(val == 'chat'){
                    var flag = 0;
                     var judge = prompt(name+"留言区");
                        if (judge) {
                            $.ajax({
                                type:"POST",
                                url:"/vote/chat/",
                                data:{"cInfo":judge, "n":this.value},
                                dataType:"json",
                                success: function(res) {
                                    if(parseInt(res) == 1){
                                        window.location.reload();
                                    }
                                }
                            });
                        } else {
{#                            alert("留言失败");#}
                        }

                }

            });

        });

        //验证字符串是否是数字
        function checkNumber(theObj) {
          var reg = /^[0-9]+.?[0-9]*$/;
          if(reg.test(theObj)){
              return true;
          }else {
              return false;
          }
        }

    </script>
</body>
</html>